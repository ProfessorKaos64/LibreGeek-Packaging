#!/usr/bin/make -f

# add c++ hardening options (upstream makefile doesn't use CPPFLAGS)
export DEB_BUILD_MAINT_OPTIONS = hardening=+all
export DEB_CFLAGS_MAINT_APPEND = $(shell dpkg-buildflags --get CPPFLAGS)

export DEB_CXXFLAGS_MAINT_STRIP=-g -O2
export DEB_CFLAGS_MAINT_STRIP=-g -O2

# Sacrifice linking speed to avoid using so much memory
#export DEB_LDFLAGS_MAINT_APPEND = -Wl,--no-keep-memory

ARCH=$(shell dpkg-architecture -qDEB_HOST_ARCH)

ifeq ($(ARCH),amd64)
	EXTRA_OPTS = PTR64=1
else ifeq ($(ARCH),arm64)
    EXTRA_OPTS = ARCHOPTS="-mabi=lp64" NOASM=1 FORCE_DRC_C_BACKEND=1
endif

%:
	dh $@ --parallel

override_dh_auto_build:
	# MAME
	dh_auto_build -- OSD="retro" verbose=1 RETRO=1 NOWERROR=1 OS="linux" TARGETOS="linux" CONFIG="libretro" NO_USE_MIDI="1" $(EXTRA_OPTS) TARGET=mame SUBTARGET=arcade
	mv *.so mame2016_libretro.so
	# MESS
	dh_auto_build -- OSD="retro" verbose=1 RETRO=1 NOWERROR=1 OS="linux" TARGETOS="linux" CONFIG="libretro" NO_USE_MIDI="1" $(EXTRA_OPTS) TARGET=mame SUBTARGET=mess

override_dh_auto_clean:
	dh_auto_clean -- OSD="retro" verbose=1 RETRO=1 NOWERROR=1 OS="linux" TARGETOS="linux" CONFIG="libretro" NO_USE_MIDI="1" $(EXTRA_OPTS) TARGET=mame
	rm -f -r 3rdparty/genie/bin/
	rm -f -r 3rdparty/genie/build/gmake.linux/obj/
